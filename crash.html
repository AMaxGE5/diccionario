<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Crash Bandicoot - PS1 (fix)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --accent:#00ff99; --bg:#0f0f10; --muted:#8f9; }
    body{background:var(--bg);color:var(--accent);font-family:Inter,Arial, sans-serif;margin:0}
    header{padding:18px;text-align:center}
    h1{margin:0 0 6px}
    .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
    #game{width:100%;height:640px;border:3px solid var(--accent);border-radius:10px;background:#000;display:flex;align-items:center;justify-content:center;position:relative}
    #status{position:absolute;left:12px;top:12px;color:var(--muted);font-size:13px}
    pre.debug{background:#071017;color:#cfe;padding:10px;border-radius:8px;overflow:auto;margin-top:12px;font-size:13px}
    a { color: var(--accent) }
    .error{color:tomato}
  </style>
</head>
<body>
  <header>
    <h1>Crash Bandicoot (PS1) — prueba con EmulatorJS</h1>
    <div style="color:var(--muted)">Este archivo intenta detectar y cargar el .bin y la BIOS antes de arrancar el emulador.</div>
  </header>

  <main class="wrap">
    <div id="game"><div id="status">Comprobando...</div></div>
    <pre id="debug" class="debug" aria-live="polite"></pre>
  </main>

  <script>
  (function(){
    // --------- AJUSTA AQUÍ si los archivos tienen otro nombre -------------
    const gameFile = "CrashBandicoot.bin";
    const biosFile = "scph1001.bin";
    // --------------------------------------------------------------------
    const loaderSrc = "https://cdn.emulatorjs.org/stable/data/loader.js";
    const pathtodata = "https://cdn.emulatorjs.org/stable/data/";

    const status = id => { document.getElementById('status').textContent = id; console.log('[EJS-FIX]', id); };
    const dbg = (t) => { const el = document.getElementById('debug'); el.textContent += t + "\n\n"; };

    if (location.protocol === 'file:') {
      status('ERROR: Abriendo vía file://. Usa un servidor local (Live Server / python -m http.server).');
      dbg('Sugerencia: en VSCode clic derecho -> "Open with Live Server" o en terminal ejecutar: python -m http.server 5500');
      return;
    }

    const base = new URL('.', location.href).href;
    const gameUrl = new URL(gameFile, base).href;
    const biosUrl = new URL(biosFile, base).href;

    dbg('URLs resueltas:');
    dbg('Juego -> ' + gameUrl);
    dbg('BIOS  -> ' + biosUrl);

    async function fetchAsBlobUrl(url, label){
      status(`Descargando ${label}...`);
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const blob = await r.blob();
        const blobUrl = URL.createObjectURL(blob);
        dbg(`${label} descargado (${(blob.size/1024|0)} KB). Creado blob URL.`);
        return blobUrl;
      } catch (err) {
        dbg(`ERROR descargando ${label}: ${err.message}`);
        throw err;
      }
    }

    (async function(){
      try {
        const [gameBlobUrl, biosBlobUrl] = await Promise.all([
          fetchAsBlobUrl(gameUrl, 'Juego'),
          fetchAsBlobUrl(biosUrl, 'BIOS')
        ]);

        // Variables necesarias para EmulatorJS
        window.EJS_player = "#game";
        window.EJS_core   = "psx";
        window.EJS_gameName = "Crash Bandicoot";
        window.EJS_color  = "#FF6600";
        window.EJS_pathtodata = pathtodata;

        // asignamos los blob: urls (loader.js soporta blob:)
        window.EJS_gameUrl = gameBlobUrl;
        window.EJS_biosUrl = biosBlobUrl;

        status('Archivos listos — cargando loader.js desde CDN...');
        dbg('Variables EJS asignadas. Se inyectará loader.js.');

        // inyectar loader.js
        const s = document.createElement('script');
        s.src = loaderSrc;
        s.onload = () => {
          status('loader.js cargado. Espera a que el core inicialice (puede tardar unos segundos).');
          dbg('loader.js onload OK. Si ves menú en pantalla, selecciona "Load Content" o espera; debería iniciarse el juego.');
        };
        s.onerror = (e) => {
          status('ERROR cargando loader.js', true);
          dbg('Fallo al cargar loader.js: ' + loaderSrc);
        };
        document.body.appendChild(s);

      } catch (e) {
        status('ERROR: No se pudieron descargar los archivos. Mira debug abajo.', true);
        dbg('Posibles causas:\n - Nombre de archivo incorrecto (may/min)\n - Archivos no en la misma carpeta que este HTML\n - CORS / redirecciones si usas raw.githubusercontent u otro dominio\n - Estás abriendo con file:// en lugar de http(s)');

        dbg('Prueba abrir estas urls en otra pestaña (deben descargar):\n' + gameUrl + '\n' + biosUrl);
        console.error(e);
      }
    })();

  })();
  </script>
</body>
</html>
